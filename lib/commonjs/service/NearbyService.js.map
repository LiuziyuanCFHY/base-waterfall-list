{"version":3,"names":["_reactQuery","require","_bizRequest","_model","useQueryUrl","fetchGoodsList","queryParams","size","channelSource","ChannelSourceEnum","POI_DETAIL","poiId","cursor","fetchUrl","params","url","method","RequestMethod","GET","headers","businessName","responseType","bizRequest","request","enableRequestParamsVerify","catch","reason","Promise","reject","e","NO_MORE","isEmptyString","str","exports","dealData","data","pages","setData","_pages","currentPage","length","items","feedList","forEach","item","push","oldLenght","useQueryNearbyGoods","handleCallback","useInfiniteQuery","pageParam","onSettled","response","lastIndex","getNextPageParam","lastPage","_lastPage$data","_lastPage$data2","undefined"],"sources":["NearbyService.ts"],"sourcesContent":["import { useInfiniteQuery } from 'react-query';\nimport {\n    bizRequest,\n    BizRequestConfig,\n    IRequestParam,\n    RequestMethod,\n} from '@locallife/biz-request';\nimport { BizTags } from '@locallife/biz-component';\n\nimport {\n    ChannelSourceEnum,\n    IUseQueryNearbyGoodsParams,\n} from '../components/waterFallList/model';\n\nexport interface KSBaseResponse {\n    [propName: string]: any;\n    message?: string;\n}\n\nexport interface ProductBizTagPositions {\n    good_item_tab_timescard?: Array<BizTags>; //好货单次标签\n    poi_good_shop_timescard?: Array<BizTags>; //好店单次标签，发现单次标签\n    special_group_buy_img_superscript?: Array<BizTags>; // 商品头图左上角标签\n}\nexport interface GoodCardModel {\n    coverUrl?: string;\n    discountPrice?: string;\n    discountText?: string;\n    distanceText?: string;\n    goodsJumpUrl?: string;\n    itemId?: string;\n    originPriceText?: string;\n    originPrice?: string;\n    poiId?: string;\n    poiJumpUrl?: string;\n    poiName?: string;\n    productTitle?: string;\n    shopDarkIcon?: string;\n    shopLightIcon?: string;\n    /** *非协议内容** */\n    realIndex?: number;\n    itemTypeCode?: number; //商品类型 21 为次卡\n    secondaryCardTimes?: number; // 次数\n    productBizTagPositions?: ProductBizTagPositions;\n    extendJson?: string; // 商业化广告埋点用\n}\n\nexport interface FeedBaseModel {\n    type: string;\n    data: any;\n    realIndex?: number;\n}\n\nexport interface CountdownInfo {\n    /**\n     * 时间戳 当前阶段结束时间\n     */\n    endTime?: number;\n    /**\n     * 文案\n     */\n    text?: string;\n    /**\n     * 文案背景图\n     */\n    bgImgUrl?: string;\n}\n\nexport interface FeedGoodsInfo {\n    cardType: string;\n    coverUrl: string;\n    productTitle: string;\n    discountPrice: string;\n    originPrice: string;\n    originPriceText: string;\n    itemId: string;\n    poiName: string;\n    poiId: string;\n    goodsJumpUrl: string;\n    goodsHalfJumpUrl: string;\n    distanceText: string;\n    discountText: string;\n    poiJumpUrl: string;\n    poiHalfJumpUrl: string;\n    shopLightIcon: string;\n    shopArrowIcon?: string;\n    shopDarkIcon: string;\n    itemTypeCode: number;\n    secondaryCardTimes: number;\n    index: string;\n    productBizTagPositions?: any;\n    brandName?: string;\n    soldStock?: number;\n    feedBackRate?: string;\n    priceSuffix?: string;\n    content?: any;\n    countdownInfo?: CountdownInfo;\n    realIndex?: number;\n    newUser?: boolean;\n    buyUrl?: string;\n    extendJson?: string;\n}\n\nexport type FeedModel = FeedBaseModel | FeedGoodsInfo;\n\nexport interface GoodsInfoList {\n    pageSize?: number;\n    goodsInfoList?: Array<GoodCardModel>;\n    feedList?: Array<FeedModel>;\n    cursor?: String;\n}\n\nexport interface KSFoodBaseResponse extends KSBaseResponse {\n    result?: number;\n    status?: number; // 200 表示成功\n    message?: string;\n}\n\nexport interface GoodsListResponse extends KSFoodBaseResponse {\n    data?: GoodsInfoList;\n}\n\nconst useQueryUrl = '/rest/n/nearby/localfood/feed/goods';\n\nconst fetchGoodsList = async (\n    queryParams: IUseQueryNearbyGoodsParams = {\n        size: '20',\n        channelSource: ChannelSourceEnum.POI_DETAIL,\n        poiId: '',\n        cursor: '',\n        fetchUrl: '',\n    },\n): Promise<GoodsListResponse> => {\n    const params: IRequestParam = {\n        url: queryParams?.fetchUrl || useQueryUrl,\n        method: RequestMethod.GET,\n        params: queryParams,\n        headers: {\n            'X-Client-Type': 1,\n        },\n        businessName: 'api',\n        responseType: 'string',\n    } as IRequestParam;\n    try {\n        return await bizRequest\n            .request(params, {\n                enableRequestParamsVerify: false,\n            } as BizRequestConfig)\n            .catch((reason) => {\n                return Promise.reject(reason);\n            });\n    } catch (e) {\n        throw e;\n    }\n};\n\nconst NO_MORE = 'nomore';\n\n// 判断字符串是否为空\nexport const isEmptyString = (str?: string): boolean =>\n    typeof str === 'undefined' || str == null || str === '';\n\n// 请求结束，处理数据\nfunction dealData(data, pages, setData) {\n    const currentPage = pages?.length ?? 0;\n    const items = pages[currentPage - 1]?.data?.feedList;\n    items?.forEach((item) => {\n        data.push(item);\n    });\n    const oldLenght = (data?.length || 0) - (items?.length || 0);\n    setData([...data], oldLenght);\n}\n\nexport function useQueryNearbyGoods(\n    queryParams: IUseQueryNearbyGoodsParams = {\n        size: '20',\n        channelSource: ChannelSourceEnum.POI_DETAIL,\n        poiId: '',\n        fetchUrl: '',\n    },\n    handleCallback,\n    setData,\n    data,\n) {\n    return useInfiniteQuery<any, Error>(\n        [queryParams?.fetchUrl || useQueryUrl],\n        (params) => {\n            return fetchGoodsList({\n                ...queryParams,\n                cursor: params.pageParam,\n            });\n        },\n        {\n            onSettled: (response) => {\n                if (response) {\n                    handleCallback(response.pages);\n                    const currentPage = response.pages.length ?? 0;\n                    if (currentPage < 1) {\n                        return;\n                    }\n                    const lastIndex = response.pages.length - 1;\n                    if (lastIndex === 0) {\n                        setData([]);\n                        dealData(data, response.pages, setData);\n                    } else {\n                        dealData(data, response.pages, setData);\n                    }\n                }\n            },\n            getNextPageParam: (lastPage) => {\n                if (lastPage?.data?.cursor !== NO_MORE) {\n                    return lastPage?.data?.cursor;\n                }\n                return undefined;\n            },\n        },\n    );\n}\n"],"mappings":"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","ignoreList":[]}