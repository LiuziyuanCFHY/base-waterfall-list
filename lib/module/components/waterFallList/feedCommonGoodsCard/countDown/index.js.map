{"version":3,"names":["React","useCallback","useEffect","useRef","useState","View","Text","padStart","styles","getServerTime","ShowWithData","getTime","timeStamp","initTimeStamp","endContent","leftTime","h","m","s","Math","floor","undefined","format","n","String","CountDown","end","countDown","intervalIDRef","showTime","setShowTime","countFinished","lftTime","callback","time","min","random","setTimeout","loopCountDown","resultTime","current","setInterval","then","result","clearInterval","catch","Date","now","createElement","data","style","container","title","memo"],"sources":["index.tsx"],"sourcesContent":["import React, { useCallback, useEffect, useRef, useState } from 'react';\nimport { View, Text } from 'react-native';\nimport padStart from 'lodash/padStart';\nimport { styles } from './style';\nimport { getServerTime } from '@locallife/utils';\nimport { ShowWithData } from '@locallife/biz-component';\n\ntype Props = {\n    timeStamp: number;\n    end?: () => void;\n    endContent?: string;\n};\n\nfunction getTime(\n    timeStamp: number,\n    initTimeStamp: number,\n    endContent?: string,\n) {\n    const leftTime = timeStamp - initTimeStamp;\n    let h, m, s;\n    if (leftTime > 0) {\n        h = Math.floor(leftTime / 1000 / 60 / 60);\n        m = Math.floor((leftTime / 1000 / 60) % 60);\n        s = Math.floor((leftTime / 1000) % 60);\n    } else {\n        return endContent ? endContent : undefined;\n    }\n    const format = (n) => {\n        return padStart(String(n), 2, '0');\n    };\n    return `${format(h)}:${format(m)}:${format(s)}`;\n}\n\n// 商品item左侧封面倒计时组件\nfunction CountDown({ timeStamp, end, endContent }: Props) {\n    const countDown = useCallback(async () => {\n        return await getServerTime();\n    }, []);\n\n    const intervalIDRef = useRef<NodeJS.Timer>();\n    const [showTime, setShowTime] = useState('');\n\n    function countFinished(lftTime: number, callback?: () => void) {\n        if (callback) {\n            // lftTime 指到计时被舍入的部分，比如到计时剩余 100 ms，但因为小于 1s，会显示 0，lftTime = 100；\n            const time = Math.min(1000, lftTime + Math.random() * 1000);\n            setTimeout(() => {\n                callback();\n            }, time);\n        }\n    }\n\n    const loopCountDown = useCallback(\n        (timeStamp, resultTime, endContent) => {\n            //@ts-ignore\n            setShowTime(getTime(timeStamp, resultTime, endContent));\n            if (showTime !== endContent) {\n                intervalIDRef.current = setInterval(() => {\n                    countDown().then((result) => {\n                        //@ts-ignore\n                        setShowTime(getTime(timeStamp, result, endContent));\n                        if (showTime === endContent) {\n                            countFinished(timeStamp - result, end);\n                            //@ts-ignore\n                            clearInterval(intervalIDRef?.current);\n                        }\n                    });\n                }, 1000);\n            } else {\n                countFinished(timeStamp - resultTime, end);\n            }\n        },\n        [countDown, end, showTime],\n    );\n\n    useEffect(() => {\n        countDown()\n            .then((resultTime) => {\n                loopCountDown(timeStamp, resultTime, endContent);\n            })\n            .catch(() => {\n                loopCountDown(timeStamp, Date.now(), endContent);\n            });\n\n        return () => {\n            if (intervalIDRef?.current) {\n                //@ts-ignore\n                clearInterval(intervalIDRef?.current);\n            }\n        };\n    }, [countDown, endContent, loopCountDown, showTime, timeStamp]);\n    return (\n        <ShowWithData data={showTime}>\n            <View style={styles.container}>\n                <Text style={styles.title}>{showTime}</Text>\n            </View>\n        </ShowWithData>\n    );\n}\n\nexport default React.memo(CountDown);\n"],"mappings":"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","ignoreList":[]}