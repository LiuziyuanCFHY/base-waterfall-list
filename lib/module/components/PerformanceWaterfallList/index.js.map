{"version":3,"names":["React","useRef","useState","useEffect","useImperativeHandle","memo","forwardRef","useCallback","useMemo","FlatList","WaterFallRowItem","PerformanceWaterfallList","props","ref","data","numColumns","onItemLayoutDone","marginLeft","marginRight","cellInnerMargin","cellTopMargin","otherProps","_itemHeightsRef","flatListRef","update","forceUpdate","listData","changeListData","current","flatList","refreshList","offset","animated","_flatListRef$current","scrollToOffset","forceUpdateLayout","setForceUpdateLayout","columnHeights","Array","fill","rowData","rowIndex","rowOffsetTop","dataSource","forEach","item","index","columnIndex","idx","itemH","offsetTop","length","_dataSource$rowIndex","rowH","push","itemData","largestItem","sort","a","b","onItemHeightChange","height","i","undefined","onLayout","e","nativeEvent","layout","renderItem","_index","createElement","cusTomRowStyle","keyExtractor","viewabilityConfig","viewAreaCoveragePercentThreshold","_extends","horizontal","onViewableItemsChanged"],"sources":["index.tsx"],"sourcesContent":["import React, {\n    useRef,\n    useState,\n    useEffect,\n    useImperativeHandle,\n    memo,\n    forwardRef,\n    useCallback,\n    useMemo,\n} from 'react';\nimport { FlatList } from 'react-native';\nimport { IWaterFallList, IWaterFallListProps, RowData, ItemData } from './type';\nimport WaterFallRowItem from './waterFallRowItem';\n\nconst PerformanceWaterfallList = memo(\n    forwardRef((props: IWaterFallListProps, ref) => {\n        const {\n            data,\n            numColumns = 2,\n            onItemLayoutDone,\n            marginLeft,\n            marginRight,\n            cellInnerMargin,\n            cellTopMargin,\n            ...otherProps\n        } = props;\n        const _itemHeightsRef = useRef<number[]>([]);\n        const flatListRef = useRef<FlatList>(null);\n\n        const [update, forceUpdate] = useState(false);\n        const [listData, changeListData] = useState<RowData[]>([]);\n\n        useEffect(() => {\n            _itemHeightsRef.current = [];\n        }, [numColumns]);\n\n        useImperativeHandle(\n            ref,\n            () => {\n                return {\n                    flatList: flatListRef.current,\n                    refreshList(offset = 0, animated = true) {\n                        _itemHeightsRef.current = [];\n                        flatListRef.current?.scrollToOffset({\n                            offset,\n                            animated,\n                        });\n                    },\n                };\n            },\n            [],\n        );\n\n        const [forceUpdateLayout, setForceUpdateLayout] = useState(0);\n\n        useMemo(() => {\n            if (!data) {\n                return;\n            }\n            if (forceUpdateLayout > 0) {\n                setForceUpdateLayout(forceUpdateLayout);\n            }\n            const columnHeights = new Array(numColumns).fill(0);\n            let rowData: ItemData[] = [];\n            let rowIndex = 0;\n            let rowOffsetTop = 0;\n            const dataSource: RowData[] = [];\n            data.forEach((item, index) => {\n                /**\n                 * 选中当前高度最小的列 将元素放在高度最小的列\n                 */\n                let columnIndex = 0;\n                for (let idx = 1; idx < numColumns; idx++) {\n                    if (columnHeights[columnIndex] > columnHeights[idx]) {\n                        columnIndex = idx;\n                        break;\n                    }\n                }\n                const itemH = _itemHeightsRef.current[index] || 0;\n                const offsetTop = columnHeights[columnIndex] || 0;\n                columnHeights[columnIndex] += itemH;\n\n                if (rowData.length === numColumns) {\n                    rowOffsetTop += dataSource[rowIndex]?.rowH || 0;\n                    rowData = [];\n                    rowIndex++;\n                }\n                rowData.push({\n                    offsetTop,\n                    itemH,\n                    index,\n                    itemData: item,\n                    columnIndex,\n                });\n\n                /**\n                 * 一行的高度由最高的item决定\n                 * 获取一行中 最高的item\n                 */\n                const largestItem = rowData.sort(\n                    (a, b) => b.itemH + b.offsetTop - (a.itemH + a.offsetTop),\n                )[0];\n\n                const rowH =\n                    largestItem.offsetTop + largestItem.itemH - rowOffsetTop;\n                dataSource[rowIndex] = {\n                    rowIndex,\n                    rowData,\n                    rowH,\n                    rowOffsetTop,\n                };\n            });\n\n            forceUpdate(false);\n            changeListData(dataSource);\n        }, [data, numColumns, forceUpdateLayout]);\n\n        /**\n         * 收集每个item的实际高度\n         */\n        const onItemHeightChange = useCallback(\n            (height: number, index: number) => {\n                if (!data) {\n                    return;\n                }\n                if (_itemHeightsRef.current[index] === height) {\n                    return;\n                }\n\n                _itemHeightsRef.current[index] = height;\n                for (let i = 0; i < data.length; i++) {\n                    if (_itemHeightsRef.current[i] === undefined) {\n                        return;\n                    }\n                }\n                /**\n                 * 所有item高度收集完毕后强制刷新页面\n                 */\n                forceUpdate(!update);\n                setForceUpdateLayout(forceUpdateLayout + 1);\n                onItemLayoutDone && onItemLayoutDone();\n            },\n            [data, forceUpdateLayout, onItemLayoutDone, update],\n        );\n\n        const onLayout = useCallback(\n            (e, index) => {\n                if (\n                    _itemHeightsRef.current[index] === undefined ||\n                    _itemHeightsRef.current[index] === 0\n                ) {\n                    onItemHeightChange(e.nativeEvent.layout.height, index);\n                }\n            },\n            [onItemHeightChange],\n        );\n\n        const renderItem = useCallback(\n            ({ item, _index }) => {\n                return (\n                    <WaterFallRowItem\n                        item={item}\n                        cusTomRowStyle={undefined}\n                        numColumns={numColumns}\n                        onLayout={onLayout}\n                        renderItem={props.renderItem}\n                        marginLeft={marginLeft}\n                        marginRight={marginRight}\n                        cellInnerMargin={cellInnerMargin}\n                        cellTopMargin={cellTopMargin}\n                    />\n                );\n            },\n            [\n                cellInnerMargin,\n                cellTopMargin,\n                marginLeft,\n                marginRight,\n                numColumns,\n                onLayout,\n                props.renderItem,\n            ],\n        );\n\n        const keyExtractor = useCallback((item, index) => `row_${index}`, []);\n\n        const viewabilityConfig = useMemo(() => {\n            return {\n                viewAreaCoveragePercentThreshold: 1,\n            };\n        }, []);\n\n        return (\n            <FlatList\n                keyExtractor={keyExtractor}\n                {...otherProps}\n                ref={flatListRef}\n                horizontal={false}\n                numColumns={1}\n                data={listData}\n                renderItem={renderItem}\n                viewabilityConfig={viewabilityConfig}\n                onViewableItemsChanged={props.onViewableItemsChanged}\n            />\n        );\n    }),\n);\n\nexport default memo(\n    forwardRef<IWaterFallList, IWaterFallListProps>(PerformanceWaterfallList),\n);\n\nexport { PerformanceWaterfallList };\n"],"mappings":"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","ignoreList":[]}